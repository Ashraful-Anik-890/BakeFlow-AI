<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BakeFlow AI - Smart Demand Prediction</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb; /* Prominent light grey background (gray-200) */
        }
        .bg-canvas {
            position: fixed; /* Keep it fixed so it doesn't scroll with content */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Behind all content */
        }
        .container {
            max-width: 768px; /* Adjusted max-width for single column */
            background-color: #f3f4f6; /* Light grey for the main container (gray-100) */
            z-index: 1; /* Above the background canvas */
            position: relative; /* For z-index to work */
        }
        /* Custom styles for chart bars */
        .chart-bar {
            background-color: #fb923c; /* Orange 400 */
            margin-right: 4px;
            border-radius: 6px 6px 0 0; /* Rounded top corners */
            transition: height 0.5s ease-out, background-color 0.3s ease;
            display: flex;
            flex-direction: column; /* Stack units and line */
            align-items: center;
            justify-content: flex-end; /* Align content to bottom of bar */
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            padding-bottom: 4px;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Subtle shadow */
        }
        .chart-bar:hover {
            background-color: #f97316; /* Orange 500 on hover */
        }
        .chart-bar.prediction-bar { /* Style for the new prediction bar */
            background-color: #2563eb; /* Blue 600 for prediction */
            box-shadow: 0 4px 10px -2px rgba(37, 99, 235, 0.4), 0 2px 5px -1px rgba(37, 99, 235, 0.2);
        }
        .chart-bar.prediction-bar:hover {
            background-color: #1d4ed8; /* Blue 700 on hover */
        }
        .chart-bar .units-sold-text {
            position: absolute; /* Position text above the bar */
            top: -1.5em; /* Adjust as needed */
            color: #4b5563; /* Gray 600 */
            font-size: 0.8em;
            white-space: nowrap;
        }

        .chart-label {
            font-size: 0.75rem;
            color: #4b5563; /* Gray 600 */
            text-align: center;
            padding-top: 6px;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85); /* Slightly more opaque */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 12px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #f97316; /* Orange spinner */
            border-radius: 50%;
            width: 50px; /* Slightly larger spinner */
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scroll behavior for navigation */
        html {
            scroll-behavior: smooth;
        }
        /* Style for the CSV demo pre block */
        .csv-demo pre {
            background-color: #f3f4f6; /* Lighter grey for code block (gray-100) */
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: monospace;
            font-size: 0.875rem;
            color: #333;
            border: 1px solid #d1d5db; /* gray-300 */
        }

        .weather-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            border-radius: 8px;
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #e5e7eb; /* gray-200 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            text-align: center; /* Center content horizontally */
        }
        .weather-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .weather-day {
            font-weight: bold;
            color: #4b5563; /* gray-600 */
            margin-bottom: 0.25rem;
        }
        .weather-temp {
            font-size: 0.875rem;
            color: #6b7280; /* gray-500 */
            line-height: 1.2; /* Tighter line spacing */
        }
        .weather-detail {
            font-size: 0.75rem;
            color: #9ca3af; /* gray-400 */
            line-height: 1.2; /* Tighter line spacing */
        }
        .blurb-output-area, .suggestion-output-area {
            background-color: #fff7ed; /* Orange 50 (very light orange) */
            border: 1px solid #fed7aa; /* Orange 200 */
            padding: 1.5rem;
            border-radius: 10px;
            min-height: 80px; /* Give it some height */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #7c2d12; /* Darker orange text */
            font-style: italic;
            box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            text-align: left; /* Align text left for readability */
        }
        .blurb-output-area p, .suggestion-output-area p {
            margin: 0; /* Remove default paragraph margins inside */
        }
        .section-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
            color: #f97316; /* Orange 500 */
        }
        .main-title-icon {
            font-size: 2.5rem;
            color: #f97316;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .hero-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-200 min-h-screen flex flex-col items-center p-4">

    <!-- Background Canvas for interactive animation -->
    <canvas id="bgCanvas" class="bg-canvas"></canvas>

    <div class="container shadow-xl rounded-xl p-6 md:p-10 relative mt-8 w-full space-y-8">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="spinner mb-4"></div>
            <p class="text-gray-700 text-xl font-semibold">Baking up your prediction...</p>
        </div>

        <header class="text-center mb-0"> <!-- Removed bottom margin -->
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">
                <span class="main-title-icon">ü•ê</span> BakeFlow AI
            </h1>
            <p class="text-xl text-orange-600 font-semibold mb-6">Smart Demand Prediction for Artisanal Bakeries</p>

            <div id="purpose" class="bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-sm">
                <h2 class="text-2xl font-bold text-gray-700 mb-3">What is BakeFlow AI?</h2>
                <p class="text-gray-600 leading-relaxed">
                    BakeFlow AI is your intelligent assistant designed to help artisanal bakeries
                    like yours bake smarter. Our tool analyzes your past sales data, combined with
                    important external factors like **day of the week** and **weather forecasts**,
                    to provide highly accurate predictions for your daily demand.
                </p>
                <p class="text-gray-600 leading-relaxed mt-2">
                    <strong class="text-gray-700">Our Purpose:</strong> To empower bakery owners to significantly <strong class="text-gray-700">reduce food waste</strong>
                    (saving costs and helping the planet!) and **maximize sales** by ensuring you
                    bake just the right amount of your delicious products every day. Say goodbye to
                    guessing and hello to optimized production!
                </p>
            </div>
        </header>

        <!-- Main content sections, now stacked -->

        <!-- I. Three-Day Weather Forecast -->
        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-lg">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-5">
                <h2 class="text-2xl font-semibold text-gray-700 flex items-center mb-3 sm:mb-0">
                    <span class="section-icon">‚òÅÔ∏è</span> I. Three-Day Weather Forecast
                </h2>
                <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                    <span id="currentLocationDisplay" class="text-gray-600 text-sm font-medium w-full sm:w-auto"></span>
                    <input type="text" id="locationInput" placeholder="Enter City, State/Zip" class="w-full sm:w-32 p-1 border border-gray-300 rounded-md text-sm focus:ring-orange-500 focus:border-orange-500">
                    <button id="updateLocationButton" class="bg-orange-500 text-white px-3 py-1 rounded-md text-sm hover:bg-orange-600 transition-colors duration-200 w-full sm:w-auto">Update</button>
                </div>
            </div>
            <div id="weatherForecast" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <!-- Weather cards will be injected here -->
                <p class="text-gray-500 text-center col-span-full">Loading weather data...</p>
            </div>
            <p class="text-gray-500 text-sm text-center mt-4">Simulated forecast for your location.</p>
        </div>

        <!-- II. Provide Your Data & Inputs -->
        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="section-icon">üìÅ</span> II. Provide Your Data & Inputs
            </h2>
            <div class="image-placeholder">
                <img src="https://via.placeholder.com/600x150/d1d5db/4b5563?text=Upload+Your+Sales+Data" alt="Placeholder for sales data upload visual" class="w-full h-full object-cover">
            </div>
            <p class="text-sm text-gray-500 mb-4">
                Upload a CSV file containing your historical sales. Each row should have:
                <code class="font-bold text-gray-700">Date</code>,
                <code class="font-bold text-gray-700">Item_Name</code>, and
                <code class="font-bold text-gray-700">Units_Sold</code>.
            </p>
            <div class="csv-demo mb-4">
                <p class="text-gray-600 text-sm mb-2 font-semibold">CSV File Format Example:</p>
                <pre class="whitespace-pre-wrap">Date,Item_Name,Units_Sold
2025-07-15,Sourdough Loaf,100
2025-07-15,Croissant,150
2025-07-16,Sourdough Loaf,95
2025-07-16,Baguette,80
2025-07-17,Sourdough Loaf,110
2025-07-17,Muffin,120
...</pre>
                <a href="#" id="downloadSampleCsv" class="text-orange-600 hover:underline text-sm font-medium mt-2 block">
                    Download Sample CSV
                </a>
            </div>

            <input type="file" id="csvFileInput" accept=".csv" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-colors duration-200">
            <p id="fileStatus" class="text-sm text-red-500 mt-2 hidden"></p>
        </div>

        <!-- III. Set Prediction Details -->
        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="section-icon">‚öôÔ∏è</span> III. Set Prediction Details
            </h2>
            <div class="mb-4">
                <label for="itemSelect" class="block text-gray-700 text-sm font-bold mb-2">Select Item for Prediction:</label>
                <select id="itemSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-colors duration-200" disabled>
                    <option value="">Upload CSV to see items</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="predictionAlgorithm" class="block text-gray-700 text-sm font-bold mb-2">Select Prediction Algorithm:</label>
                <select id="predictionAlgorithm" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-colors duration-200">
                    <option value="weightedAverage">Weighted Average (Recommended)</option>
                    <option value="simpleMovingAverage">Simple Moving Average</option>
                    <option value="dayOfWeekTrend">Day-of-Week Trend</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="predictionDate" class="block text-gray-700 text-sm font-bold mb-2">Prediction Date (Tomorrow):</label>
                <input type="date" id="predictionDate" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                <span id="predictionDayOfWeek" class="block text-gray-500 text-sm mt-1"></span>
            </div>
            <div class="mb-4">
                <label for="weatherSelect" class="block text-gray-700 text-sm font-bold mb-2">Expected Weather:</label>
                <select id="weatherSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-colors duration-200">
                    <option value="Sunny">Sunny ‚òÄÔ∏è</option>
                    <option value="Cloudy">Cloudy ‚òÅÔ∏è</option>
                    <option value="Rainy">Rainy üåßÔ∏è</option>
                    <option value="Snowy">Snowy ‚ùÑÔ∏è</option>
                </select>
            </div>
            <div class="mb-6 flex items-center">
                <input type="checkbox" id="promotionToggle" class="mr-2 h-5 w-5 text-orange-600 rounded focus:ring-orange-500">
                <label for="promotionToggle" class="text-gray-700 text-sm font-bold">Expect a Promotion/Special Event?</label>
            </div>

            <button id="predictButton" class="w-full bg-orange-600 text-white py-4 px-4 rounded-xl font-bold text-lg hover:bg-orange-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 shadow-md">
                Get My BakeFlow Prediction
            </button>
        </div>

        <!-- IV. Overall Sales Distribution by Item -->
        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="section-icon">üìä</span> IV. Overall Sales Distribution by Item
            </h2>
            <div class="flex flex-col md:flex-row items-center justify-center gap-6">
                <canvas id="pieChartCanvas" class="w-full" style="max-width: 256px; max-height: 256px;"></canvas> <!-- Ensure square constraint -->
                <div id="pieChartLegend" class="w-full md:w-1/2 p-4 bg-white rounded-lg shadow-inner border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Item Proportions:</h3>
                    <ul id="legendList" class="text-gray-600 text-sm">
                        <!-- Legend items will be injected here -->
                    </ul>
                </div>
            </div>
            <p class="text-gray-500 text-sm text-center mt-3">Distribution of total units sold across all items in your uploaded data.</p>
        </div>

        <!-- V. Your Smart Prediction -->
        <div id="predictionSection" class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-lg"> <!-- Added ID for scrolling -->
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="section-icon">‚ú®</span> V. Your Smart Prediction
            </h2>
            <div id="predictionOutput" class="bg-orange-50 p-8 rounded-lg text-center mb-8 border border-orange-200 shadow-inner">
                <p class="text-orange-800 text-lg mb-2 font-medium">Predicted Units for <span id="predictedItemName">Selected Item</span>:</p>
                <p id="predictedUnits" class="text-orange-900 text-6xl font-extrabold animate-pulse">--</p>
                <p id="predictionExplanation" class="text-orange-700 text-sm mt-5 italic leading-relaxed"></p>
            </div>
        </div>
        
        <!-- VI. Promotion Blurb Generator (Always visible) -->
        <div id="promotionBlurbSection" class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="section-icon">‚úçÔ∏è</span> VI. ‚ú® Promotion Blurb Generator ‚ú®
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                If you're planning a promotion, let BakeFlow AI craft a quick marketing blurb for you!
            </p>
            <button id="generateBlurbButton" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-bold text-md hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Generate Promotion Blurb
            </button>
            <div id="blurbOutput" class="blurb-output-area mt-4 text-sm hidden">
                <!-- Blurb will be displayed here -->
            </div>
            <div id="blurbLoading" class="hidden text-center mt-4">
                <div class="spinner w-8 h-8 border-2 mb-2 mx-auto"></div>
                <p class="text-gray-600">Generating blurb...</p>
            </div>
        </div>

        <!-- VII. Recent Sales Flow -->
        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="section-icon">üìä</span> VII. Recent Sales Flow
            </h2>
            <div id="historicalChart" class="w-full h-56 bg-white p-5 rounded-lg flex items-end justify-around border border-gray-300 shadow-inner">
                <!-- Chart bars will be injected here -->
            </div>
            <p class="text-gray-500 text-sm text-center mt-3" id="chartLabel">Past 7 Days of Sales for Selected Item and Tomorrow's Prediction</p>
        </div>

        <!-- VIII. Ingredient Substitution Suggestor -->
        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 flex items-center">
                <span class="section-icon">üß™</span> VIII. ‚ú® Ingredient Substitution Suggestor ‚ú®
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                Need to swap an ingredient? Get smart suggestions for your baking needs.
            </p>
            <div class="mb-4">
                <label for="originalIngredient" class="block text-gray-700 text-sm font-bold mb-2">Original Ingredient (e.g., "Butter"):</label>
                <input type="text" id="originalIngredient" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-colors duration-200" placeholder="e.g., All-purpose flour">
            </div>
            <div class="mb-4">
                <label for="substituteIngredient" class="block text-gray-700 text-sm font-bold mb-2">Substitute For (Optional, e.g., "Vegan alternative"):</label>
                <input type="text" id="substituteIngredient" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-colors duration-200" placeholder="e.g., Gluten-free flour">
            </div>
            <div class="mb-6">
                <label for="bakedGoodType" class="block text-gray-700 text-sm font-bold mb-2">Type of Baked Good (Optional, e.g., "Bread"):</label>
                <input type="text" id="bakedGoodType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-colors duration-200" placeholder="e.g., Cake, Cookies, Sourdough">
            </div>

            <button id="getSuggestionButton" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-bold text-md hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                Get Substitution Suggestion ‚ú®
            </button>
            <div id="suggestionOutput" class="suggestion-output-area mt-4 text-sm hidden">
                <!-- Suggestions will be displayed here -->
            </div>
            <div id="suggestionLoading" class="hidden text-center mt-4">
                <div class="spinner w-8 h-8 border-2 mb-2 mx-auto"></div>
                <p class="text-gray-600">Finding substitutions...</p>
            </div>
        </div>

        <!-- IX. Contact Us Section -->
        <div id="contact" class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-5 flex items-center">
                <span class="section-icon">‚úâÔ∏è</span> IX. Contact Us
            </h2>
            <p class="text-gray-600 leading-relaxed mb-4">
                Have questions, feedback, or want to explore custom solutions for your bakery?
                We'd love to hear from you!
            </p>
            <p class="text-gray-600 font-bold mb-2">Developed by: MD. Ashraful Al Amin</p>
            <p class="text-gray-600 text-sm italic">
                A passionate innovator dedicated to empowering small businesses with intelligent,
                user-friendly solutions that drive efficiency, reduce waste, and foster growth
                in the culinary world.
            </p>
            <p class="text-gray-600 font-bold mt-4">
                Reach out to me at: <a href="mailto:ashrafulanik08@gmail.com" class="text-orange-600 hover:underline">ashrafulanik08@gmail.com</a>
            </p>
        </div>


        <footer class="mt-12 text-center">
            <nav class="flex justify-center space-x-6 text-gray-600 text-md font-medium">
                <a href="#top" class="hover:text-orange-600 transition-colors duration-200">Home</a>
                <a href="#purpose" class="hover:text-orange-600 transition-colors duration-200">About BakeFlow</a>
                <a href="#contact" class="hover:text-orange-600 transition-colors duration-200">Contact Us</a>
            </nav>
            <p class="text-gray-500 text-sm mt-4">&copy; 2026 BakeFlow AI. All rights reserved.</p>
        </footer>

        <!-- Message Box -->
        <div id="messageBox" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
            <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm transform scale-95 opacity-0 transition-all duration-300 ease-out" id="messageBoxContent">
                <p id="messageBoxText" class="text-gray-800 text-xl font-semibold mb-6"></p>
                <button onclick="hideMessageBox()" class="bg-orange-600 text-white py-3 px-6 rounded-lg hover:bg-orange-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2">Got It!</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables for persistence mock
        const __app_id = 'bakery-demand-predict-ai';
        const __initial_auth_token = 'mock-auth-token';

        let historicalData = []; // Stores the parsed CSV data
        let selectedItem = "Sourdough Loaf"; // Default selected item, will be updated by CSV
        let predictedUnits = 0; // Store the last predicted units for the blurb generator
        let currentSimulatedLocation = "Boston, MA"; // Default simulated location

        const weatherInfluence = { // Mock weather influence on sales (percentages)
            'Sunny': 1.1,
            'Cloudy': 0.95,
            'Rainy': 0.8,
            'Snowy': 0.7
        };
        const weatherIcons = {
            'Sunny': '‚òÄÔ∏è',
            'Cloudy': '‚òÅÔ∏è',
            'Rainy': 'üåßÔ∏è',
            'Snowy': '‚ùÑÔ∏è'
        };
        const promotionInfluence = 1.2; // 20% sales increase during a promotion

        // Canvas for background animation
        const bgCanvas = document.getElementById('bgCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        let particles = [];
        let mouseX = window.innerWidth / 2;
        let mouseY = window.innerHeight / 2;

        // Set initial canvas size
        function resizeCanvas() {
            bgCanvas.width = window.innerWidth;
            bgCanvas.height = window.innerHeight;
            // Re-initialize particles on resize for better distribution
            initParticles();
        }

        // Particle constructor
        function Particle(x, y) {
            this.x = x;
            this.y = y;
            this.size = Math.random() * 2 + 0.5; // Small size
            this.speedX = Math.random() * 0.2 - 0.1; // Slow movement
            this.speedY = Math.random() * 0.2 - 0.1;
            this.color = `rgba(251, 146, 60, ${Math.random() * 0.3 + 0.1})`; // Subtle orange, very faint
            this.originalX = x;
            this.originalY = y;
        }

        Particle.prototype.update = function() {
            // Move particle
            this.x += this.speedX;
            this.y += this.speedY;

            // Simple boundary check
            if (this.x < 0 || this.x > bgCanvas.width) this.speedX *= -1;
            if (this.y < 0 || this.y > bgCanvas.height) this.speedY *= -1;

            // React to mouse proximity
            const dx = mouseX - this.x;
            const dy = mouseY - this.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const maxDistance = 150; // Influence radius

            if (distance < maxDistance) {
                const forceDirectionX = dx / distance;
                const forceDirectionY = dy / distance;
                const force = (maxDistance - distance) / maxDistance;
                const maxSpeed = 2;

                this.x -= forceDirectionX * force * maxSpeed * 0.05; // Push away gently
                this.y -= forceDirectionY * force * maxSpeed * 0.05;
            } else {
                // Gently move back towards original position if far from mouse
                const restoreSpeed = 0.005;
                this.x += (this.originalX - this.x) * restoreSpeed;
                this.y += (this.originalY - this.y) * restoreSpeed;
            }
        };

        Particle.prototype.draw = function() {
            bgCtx.fillStyle = this.color;
            bgCtx.beginPath();
            bgCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            bgCtx.fill();
        };

        function initParticles() {
            particles = [];
            const numberOfParticles = (bgCanvas.width * bgCanvas.height) / 9000; // Density
            for (let i = 0; i < numberOfParticles; i++) {
                const x = Math.random() * bgCanvas.width;
                const y = Math.random() * bgCanvas.height;
                particles.push(new Particle(x, y));
            }
        }

        function animateParticles() {
            bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw();
            }
            requestAnimationFrame(animateParticles);
        }

        // Event listeners for background animation
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('mousemove', (event) => {
            mouseX = event.clientX;
            mouseY = event.clientY;
        });


        // Scroll to top for 'Home' navigation
        document.querySelector('a[href="#top"]').addEventListener('click', function(e) {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        // Mock scroll for 'About' and 'Contact'
        document.querySelector('a[href="#purpose"]').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('purpose').scrollIntoView({ behavior: 'smooth' });
        });
         document.querySelector('a[href="#contact"]').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('contact').scrollIntoView({ behavior: 'smooth' }); // Scroll to actual contact section
        });


        document.addEventListener('DOMContentLoaded', () => {
            // Set tomorrow's date for prediction
            const today = new Date();
            today.setDate(today.getDate() + 1); // Set to tomorrow
            const tomorrow = today.toISOString().split('T')[0];
            document.getElementById('predictionDate').value = tomorrow;
            updateDayOfWeek(tomorrow);

            // Event Listeners
            document.getElementById('csvFileInput').addEventListener('change', handleFileSelect);
            document.getElementById('predictButton').addEventListener('click', handlePrediction);
            document.getElementById('downloadSampleCsv').addEventListener('click', downloadSampleCsv);
            document.getElementById('itemSelect').addEventListener('change', (event) => {
                selectedItem = event.target.value;
                document.getElementById('predictedItemName').textContent = `"${selectedItem}"`;
                updateChartLabel(); // Update chart label when item changes
                displayHistoricalChart(historicalData); // Redraw chart for new item
            });

            document.getElementById('generateBlurbButton').addEventListener('click', generatePromotionBlurb);
            document.getElementById('promotionToggle').addEventListener('change', updateBlurbButtonState); // Re-evaluate blurb button state

            document.getElementById('getSuggestionButton').addEventListener('click', getSubstitutionSuggestion);
            document.getElementById('originalIngredient').addEventListener('input', updateSuggestionButtonState);
            document.getElementById('substituteIngredient').addEventListener('input', updateSuggestionButtonState);
            document.getElementById('bakedGoodType').addEventListener('input', updateSuggestionButtonState);

            // Weather location update
            document.getElementById('updateLocationButton').addEventListener('click', () => {
                const newLocation = document.getElementById('locationInput').value.trim();
                if (newLocation) {
                    currentSimulatedLocation = newLocation;
                    fetchAndDisplayWeatherForecast(newLocation);
                } else {
                    showMessageBox("Please enter a location to update the weather forecast.");
                }
            });
            document.getElementById('locationInput').value = currentSimulatedLocation; // Set default in input field

            // Add algorithm selection listener
            document.getElementById('predictionAlgorithm').addEventListener('change', () => {
                // When algorithm changes, clear prediction to force new calculation
                predictedUnits = 0;
                displayPrediction('--', '');
            });


            // Initial chart load (will be empty until CSV is uploaded)
            displayHistoricalChart([]);
            drawPieChart([]); // Initial empty pie chart
            fetchAndDisplayWeatherForecast(currentSimulatedLocation); // Fetch and display initial weather forecast

            // Start background animation
            resizeCanvas(); // Set initial size and populate particles
            animateParticles(); // Start animation loop

            // Initial check for button states
            updateBlurbButtonState();
            updateSuggestionButtonState();
        });

        /**
         * Updates the state of the generate blurb button (disabled/enabled).
         * It should be enabled only if a prediction has been made AND promotionToggle is checked.
         */
        function updateBlurbButtonState() {
            const generateBlurbButton = document.getElementById('generateBlurbButton');
            const isPromotionChecked = document.getElementById('promotionToggle').checked;
            
            // The button should be enabled only if a prediction has been made (predictedUnits > 0)
            // AND the promotion toggle is checked.
            if (predictedUnits > 0 && isPromotionChecked) {
                generateBlurbButton.disabled = false;
            } else {
                generateBlurbButton.disabled = true;
                // If the button is disabled, hide the blurb output
                document.getElementById('blurbOutput').classList.add('hidden');
                document.getElementById('blurbOutput').textContent = '';
            }
        }

        /**
         * Updates the state of the get suggestion button (disabled/enabled).
         * It should be enabled if at least the original ingredient is provided.
         */
        function updateSuggestionButtonState() {
            const getSuggestionButton = document.getElementById('getSuggestionButton');
            const originalIngredient = document.getElementById('originalIngredient').value.trim();
            
            if (originalIngredient.length > 0) {
                getSuggestionButton.disabled = false;
            } else {
                getSuggestionButton.disabled = true;
                document.getElementById('suggestionOutput').classList.add('hidden'); // Hide output if inputs cleared
                document.getElementById('suggestionOutput').textContent = '';
            }
        }

        /**
         * Displays a custom message box with animation.
         * @param {string} message The message to display.
         */
        function showMessageBox(message) {
            const messageBox = document.getElementById('messageBox');
            const messageBoxContent = document.getElementById('messageBoxContent');
            document.getElementById('messageBoxText').textContent = message;
            messageBox.classList.remove('hidden');
            // Trigger animation
            setTimeout(() => {
                messageBoxContent.classList.remove('opacity-0', 'scale-95');
                messageBoxContent.classList.add('opacity-100', 'scale-100');
            }, 10);
        }

        /**
         * Hides the custom message box with animation.
         */
        function hideMessageBox() {
            const messageBox = document.getElementById('messageBox');
            const messageBoxContent = document.getElementById('messageBoxContent');
            messageBoxContent.classList.remove('opacity-100', 'scale-100');
            messageBoxContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 300); // Match CSS transition duration
        }

        /**
         * Updates the displayed day of the week based on the selected date.
         * @param {string} dateString Date in YYYY-MM-DD format.
         */
        function updateDayOfWeek(dateString) {
            const date = new Date(dateString + 'T00:00:00'); // Add T00:00:00 to avoid timezone issues
            const options = { weekday: 'long' };
            document.getElementById('predictionDayOfWeek').textContent = `(${date.toLocaleDateString('en-US', options)})`;
        }

        /**
         * Handles the file selection and parses the CSV.
         * @param {Event} event The file input change event.
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const fileStatusElement = document.getElementById('fileStatus');
            if (!file) {
                fileStatusElement.textContent = 'No file selected.';
                fileStatusElement.classList.remove('hidden');
                historicalData = [];
                populateItemSelect([]);
                displayHistoricalChart([]);
                drawPieChart([]);
                predictedUnits = 0; // Reset prediction when no file
                updateBlurbButtonState();
                updateSuggestionButtonState(); // Update suggestion button state
                return;
            }

            if (file.type !== 'text/csv') {
                fileStatusElement.textContent = 'Please upload a CSV file.';
                fileStatusElement.classList.remove('hidden');
                historicalData = [];
                populateItemSelect([]);
                displayHistoricalChart([]);
                drawPieChart([]);
                predictedUnits = 0; // Reset prediction when no file
                updateBlurbButtonState();
                updateSuggestionButtonState(); // Update suggestion button state
                return;
            }

            fileStatusElement.classList.add('hidden');
            const reader = new FileReader();

            reader.onload = (e) => {
                const text = e.target.result;
                try {
                    historicalData = parseCsv(text);
                    if (historicalData.length === 0 || !historicalData[0].Date || !historicalData[0].Item_Name || !historicalData[0].Units_Sold) {
                        showMessageBox("CSV file is empty or missing required columns (Date, Item_Name, Units_Sold).");
                        historicalData = [];
                        document.getElementById('csvFileInput').value = ''; // Clear file input
                        populateItemSelect([]);
                        displayHistoricalChart([]);
                        drawPieChart([]);
                        predictedUnits = 0; // Reset prediction when no file
                        updateBlurbButtonState();
                        updateSuggestionButtonState(); // Update suggestion button state
                        return;
                    }

                    const uniqueItems = [...new Set(historicalData.map(row => row.Item_Name))];
                    populateItemSelect(uniqueItems);

                    // Set default selected item to the first one found or "Sourdough Loaf" if present
                    if (uniqueItems.includes("Sourdough Loaf")) {
                        selectedItem = "Sourdough Loaf";
                    } else if (uniqueItems.length > 0) {
                        selectedItem = uniqueItems[0];
                    } else {
                        selectedItem = ""; // No items found
                    }
                    document.getElementById('itemSelect').value = selectedItem;
                    document.getElementById('predictedItemName').textContent = `Selected Item`; // Universal text
                    updateChartLabel();

                    showMessageBox(`Successfully loaded ${historicalData.length} entries. Found items: ${uniqueItems.join(', ')}.`);
                    displayHistoricalChart(historicalData); // Display chart for the selected item
                    drawPieChart(historicalData); // Draw pie chart for all items
                    predictedUnits = 0; // Reset prediction for new data
                    updateBlurbButtonState();
                    updateSuggestionButtonState(); // Update suggestion button state
                } catch (error) {
                    showMessageBox("Error parsing CSV: " + error.message + ". Please ensure it's a valid CSV with correct headers.");
                    historicalData = [];
                    document.getElementById('csvFileInput').value = ''; // Clear file input
                    populateItemSelect([]);
                    displayHistoricalChart([]);
                    drawPieChart([]);
                    predictedUnits = 0; // Reset prediction when error
                    updateBlurbButtonState();
                    updateSuggestionButtonState(); // Update suggestion button state
                }
            };
            reader.readAsText(file);
        }

        /**
         * Populates the item selection dropdown.
         * @param {Array<string>} items An array of unique item names.
         */
        function populateItemSelect(items) {
            const itemSelect = document.getElementById('itemSelect');
            itemSelect.innerHTML = ''; // Clear existing options
            if (items.length === 0) {
                itemSelect.innerHTML = '<option value="">Upload CSV to see items</option>';
                itemSelect.disabled = true;
            } else {
                itemSelect.disabled = false;
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    itemSelect.appendChild(option);
                });
            }
        }

        /**
         * Parses CSV text into an array of objects.
         * Assumes the first row is headers.
         * @param {string} csvText The CSV content as a string.
         * @returns {Array<Object>} An array of objects representing rows.
         */
        function parseCsv(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length !== headers.length) continue; // Skip malformed rows

                const row = {};
                headers.forEach((header, index) => {
                    let value = values[index];
                    if (header === 'Units_Sold') {
                        row[header] = parseInt(value, 10);
                        if (isNaN(row[header])) row[header] = 0; // Default to 0 if not a number
                    } else if (header === 'Date') {
                        // Ensure date is parseable for consistency
                        try {
                            const date = new Date(value);
                            if (isNaN(date.getTime())) { // Check for invalid date
                                row[header] = value; // Keep original if invalid, error will be handled elsewhere
                            } else {
                                row[header] = value;
                            }
                        } catch (e) {
                            row[header] = value;
                        }
                    } else {
                        row[header] = value;
                    }
                });
                data.push(row);
            }
            return data;
        }

        /**
         * The core mock prediction function, now with algorithm selection.
         * @param {Array<Object>} history The historical sales data.
         * @param {string} item The item name to predict.
         * @param {string} predictionDate The date for which to predict (YYYY-MM-DD).
         * @param {string} predictedWeather The expected weather for the prediction day.
         * @param {boolean} isPromotion True if a promotion is expected.
         * @param {string} algorithm The selected prediction algorithm.
         * @returns {number} The predicted units to bake.
         */
        function mockAIPrediction(history, item, predictionDate, predictedWeather, isPromotion, algorithm) {
            if (history.length === 0) return 0;
            const itemHistory = history.filter(d => d.Item_Name === item);
            if (itemHistory.length === 0) return 0;
            const predDay = new Date(predictionDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long' });

            let finalPrediction = 0;
            let salesForDay, recentSales, olderSales, recentAvg, olderAvg;

            switch(algorithm) {
                case 'simpleMovingAverage':
                    const last7Days = itemHistory.slice(-7);
                    if (last7Days.length > 0) {
                        finalPrediction = last7Days.reduce((sum, val) => sum + val.Units_Sold, 0) / last7Days.length;
                    } else {
                        finalPrediction = 0;
                    }
                    break;
                case 'dayOfWeekTrend':
                    salesForDay = itemHistory.filter(d => new Date(d.Date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long' }) === predDay).map(d => d.Units_Sold);
                    if (salesForDay.length > 0) {
                        finalPrediction = salesForDay.reduce((sum, val) => sum + val, 0) / salesForDay.length;
                    } else {
                        finalPrediction = 0;
                    }
                    break;
                case 'weightedAverage': // The original, more complex model
                default:
                    salesForDay = itemHistory.filter(d => new Date(d.Date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long' }) === predDay).map(d => d.Units_Sold);
                    let basePrediction = salesForDay.length > 0 ? salesForDay.reduce((sum, val) => sum + val, 0) / salesForDay.length : itemHistory.reduce((sum, val) => sum + val.Units_Sold, 0) / itemHistory.length;
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    itemHistory.sort((a, b) => new Date(a.Date).getTime() - new Date(b.Date).getTime());
                    recentSales = itemHistory.filter(d => new Date(d.Date).getTime() >= thirtyDaysAgo.getTime());
                    olderSales = itemHistory.filter(d => new Date(d.Date).getTime() < thirtyDaysAgo.getTime());
                    recentAvg = recentSales.length > 0 ? recentSales.reduce((sum, val) => sum + val.Units_Sold, 0) / recentSales.length : basePrediction;
                    olderAvg = olderSales.length > 0 ? olderSales.reduce((sum, val) => sum + val.Units_Sold, 0) / olderSales.length : basePrediction;
                    let trendAdjustedPrediction = (recentAvg * 0.7) + (olderAvg * 0.3);
                    finalPrediction = (basePrediction * 0.5) + (trendAdjustedPrediction * 0.5);
                    break;
            }

            // Apply weather and promotion factors (if applicable to the chosen model)
            if (['weightedAverage', 'dayOfWeekTrend'].includes(algorithm) || algorithm === 'simpleMovingAverage') {
                finalPrediction *= (weatherInfluence[predictedWeather] || 1.0);
            }
            if (isPromotion) {
                finalPrediction *= promotionInfluence;
            }

            finalPrediction = finalPrediction * (1 + (Math.random() - 0.5) * 0.1); // Random variation
            return Math.max(0, Math.round(finalPrediction));
        }


        /**
         * Displays the prediction result and explanation.
         * @param {number} units The predicted number of units.
         * @param {string} explanation The explanation for the prediction.
         */
        function displayPrediction(units, explanation) {
            predictedUnits = units; // Store the predicted units
            const predictedUnitsEl = document.getElementById('predictedUnits');
            predictedUnitsEl.textContent = units;
            // Add a subtle animation class for output
            predictedUnitsEl.classList.remove('animate-pulse');
            void predictedUnitsEl.offsetWidth; // Trigger reflow
            predictedUnitsEl.classList.add('animate-pulse'); // Re-add to restart animation

            document.getElementById('predictionExplanation').textContent = explanation;

            // Update chart with prediction line (now a new bar)
            displayHistoricalChart(historicalData, predictedUnits);

            // Update blurb section button state after prediction
            updateBlurbButtonState();

            // Scroll to the prediction section
            document.getElementById('predictionSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /**
         * Handles the prediction button click.
         */
        async function handlePrediction() {
            if (historicalData.length === 0) {
                showMessageBox("Oops! Please upload your historical sales data first to get a prediction.");
                return;
            }
            if (!selectedItem) {
                showMessageBox("Please select an item from the dropdown to get a prediction.");
                return;
            }

            showLoading();

            const predictionDate = document.getElementById('predictionDate').value;
            const predictedWeather = document.getElementById('weatherSelect').value;
            const isPromotion = document.getElementById('promotionToggle').checked;
            const selectedAlgorithm = document.getElementById('predictionAlgorithm').value;
            const predDay = new Date(predictionDate + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long' });

            // Simulate network delay for model processing
            await new Promise(resolve => setTimeout(resolve, 1500));

            const units = mockAIPrediction(historicalData, selectedItem, predictionDate, predictedWeather, isPromotion, selectedAlgorithm);

            let explanation = `Using the ${selectedAlgorithm} model, we predict a demand of ${units}.`;
            if (predictedWeather) {
                explanation += ` Factored in the expected ${predictedWeather.toLowerCase()} weather.`;
            }
            if (isPromotion) {
                explanation += ` Also adjusted for an anticipated special event or promotion.`;
            }

            displayPrediction(units, explanation);
            hideLoading();
        }

        /**
         * Shows the loading overlay.
         */
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('predictButton').disabled = true;
            document.getElementById('csvFileInput').disabled = true;
            document.getElementById('itemSelect').disabled = true;
            document.getElementById('weatherSelect').disabled = true;
            document.getElementById('promotionToggle').disabled = true;
            document.getElementById('generateBlurbButton').disabled = true; // Disable blurb button too
            document.getElementById('getSuggestionButton').disabled = true; // Disable suggestion button too
        }

        /**
         * Hides the loading overlay.
         */
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('predictButton').disabled = false;
            document.getElementById('csvFileInput').disabled = false;
            document.getElementById('itemSelect').disabled = false;
            document.getElementById('weatherSelect').disabled = false;
            document.getElementById('promotionToggle').disabled = false;
            // Re-evaluate blurb and suggestion button states after loading
            updateBlurbButtonState();
            updateSuggestionButtonState();
        }

        /**
         * Updates the chart label with the currently selected item.
         */
        function updateChartLabel() {
            const chartLabelEl = document.getElementById('chartLabel');
            chartLabelEl.innerHTML = `Past 7 Days of Sales for "${selectedItem}" and Tomorrow's Prediction`;
        }

        /**
         * Displays a simple historical bar chart based on the last 7 days of data for the target item.
         * Now includes a separate bar for the prediction.
         * @param {Array<Object>} data The historical sales data.
         * @param {number} [predictedUnits] Optional: The predicted units to show as a separate bar.
         */
        function displayHistoricalChart(data, predictedUnits = null) {
            const chartContainer = document.getElementById('historicalChart');
            chartContainer.innerHTML = ''; // Clear previous chart

            const itemSales = data
                .filter(d => d.Item_Name === selectedItem && d.Date)
                .sort((a, b) => new Date(a.Date).getTime() - new Date(b.Date).getTime());

            // Get last 7 unique days of sales for the selected item
            const last7DaysSales = [];
            const uniqueDates = new Set();
            for (let i = itemSales.length - 1; i >= 0 && last7DaysSales.length < 7; i--) {
                const row = itemSales[i];
                if (!uniqueDates.has(row.Date)) {
                    last7DaysSales.unshift(row); // Add to the beginning to keep chronological order
                    uniqueDates.add(row.Date);
                }
            }

            if (last7DaysSales.length === 0 && predictedUnits === null) {
                chartContainer.innerHTML = `<p class="text-gray-500 text-center w-full h-full flex items-center justify-center">Upload your sales data to see recent trends, or select an item with sales history.</p>`;
                return;
            }

            // Calculate max units for scaling, include prediction if available
            let allUnits = last7DaysSales.map(d => d.Units_Sold);
            if (predictedUnits !== null) {
                allUnits.push(predictedUnits);
            }
            const maxUnits = Math.max(...allUnits);
            const chartHeight = chartContainer.clientHeight - 30; // Some padding for labels

            // Add historical bars
            last7DaysSales.forEach(d => {
                const barUnits = d.Units_Sold;
                const barHeight = (barUnits / maxUnits) * chartHeight;
                const date = new Date(d.Date + 'T00:00:00');
                const dayLabel = date.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });

                const barWrapper = document.createElement('div');
                barWrapper.className = 'flex flex-col items-center justify-end h-full flex-1 min-w-[10%] max-w-[12%]'; // Adjusted width

                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${barHeight}px`;
                bar.style.width = '70%';
                bar.innerHTML = `<span class="units-sold-text">${barUnits}</span>`; // Text for units sold

                barWrapper.appendChild(bar);

                const label = document.createElement('div');
                label.className = 'chart-label mt-1';
                label.textContent = dayLabel;
                barWrapper.appendChild(label);

                chartContainer.appendChild(barWrapper);
            });

            // Add a separator for the prediction bar
            if (predictedUnits !== null) {
                const separator = document.createElement('div');
                separator.className = 'w-2 h-full bg-gray-300 mx-2 rounded-full'; // Visual separator
                chartContainer.appendChild(separator);

                // Add prediction bar
                const predBarHeight = (predictedUnits / maxUnits) * chartHeight;
                const predictionDate = new Date(document.getElementById('predictionDate').value + 'T00:00:00');
                const predDayLabel = predictionDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });

                const predBarWrapper = document.createElement('div');
                predBarWrapper.className = 'flex flex-col items-center justify-end h-full flex-1 min-w-[10%] max-w-[12%]'; // Adjusted width

                const predBar = document.createElement('div');
                predBar.className = 'chart-bar prediction-bar'; // Apply specific class
                predBar.style.height = `${predBarHeight}px`;
                predBar.style.width = '70%';
                predBar.innerHTML = `<span class="units-sold-text">${predictedUnits}</span>`;

                predBarWrapper.appendChild(predBar);

                const predLabel = document.createElement('div');
                predLabel.className = 'chart-label mt-1';
                predLabel.textContent = predDayLabel;
                predBarWrapper.appendChild(predLabel);

                chartContainer.appendChild(predBarWrapper);
            }
        }

        /**
         * Draws a pie chart representing the overall sales distribution of all items.
         * @param {Array<Object>} allHistoricalData The complete historical sales data.
         */
        function drawPieChart(allHistoricalData) {
            const canvas = document.getElementById('pieChartCanvas');
            const legendList = document.getElementById('legendList');
            if (!canvas || !legendList) return; // Ensure elements exist

            // Set canvas dimensions explicitly to guarantee a perfect circle render
            const size = 256; // Fixed size for consistent circle
            canvas.width = size;
            canvas.height = size;

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear previous chart
            legendList.innerHTML = ''; // Clear previous legend

            if (allHistoricalData.length === 0) {
                ctx.font = "16px Inter";
                ctx.fillStyle = "#6b7280"; // gray-500
                ctx.textAlign = "center";
                ctx.fillText("Upload CSV to see overall sales distribution.", canvas.width / 2, canvas.height / 2);
                return;
            }

            // Aggregate units sold by item
            const itemSales = {};
            allHistoricalData.forEach(row => {
                if (itemSales[row.Item_Name]) {
                    itemSales[row.Item_Name] += row.Units_Sold;
                } else {
                    itemSales[row.Item_Name] = row.Units_Sold;
                }
            });

            const totalUnits = Object.values(itemSales).reduce((sum, val) => sum + val, 0);
            if (totalUnits === 0) {
                 ctx.font = "16px Inter";
                ctx.fillStyle = "#6b7280"; // gray-500
                ctx.textAlign = "center";
                ctx.fillText("No units sold in data to display distribution.", canvas.width / 2, canvas.height / 2);
                return;
            }

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = size / 2 * 0.7; // 70% of the canvas size

            let startAngle = 0;
            const colors = [
                '#fb923c', // Orange 400
                '#f97316', // Orange 500
                '#f59e0b', // Amber 500
                '#eab308', // Yellow 500
                '#84cc16', // Lime 500
                '#22c55e', // Green 500
                '#06b6d4', // Cyan 500
                '#3b82f6', // Blue 500
                '#6366f1', // Indigo 500
                '#a855f7', // Purple 500
                '#ec4899', // Pink 500
                '#ef4444'  // Red 500
            ];
            let colorIndex = 0;

            for (const item in itemSales) {
                const sliceAngle = (itemSales[item] / totalUnits) * 2 * Math.PI;
                const endAngle = startAngle + sliceAngle;
                const color = colors[colorIndex % colors.length];

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();

                // Draw percentage text on slice if big enough
                if (sliceAngle > Math.PI / 8) { // Only label larger slices
                    const textAngle = startAngle + sliceAngle / 2;
                    const textX = centerX + radius * 0.65 * Math.cos(textAngle);
                    const textY = centerY + radius * 0.65 * Math.sin(textAngle);
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 0.85em Inter';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${((itemSales[item] / totalUnits) * 100).toFixed(1)}%`, textX, textY);
                }


                // Add to legend
                const listItem = document.createElement('li');
                listItem.className = 'flex items-center mb-1 text-gray-600';
                listItem.innerHTML = `
                    <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: ${color};"></span>
                    ${item}: <strong>${itemSales[item]}</strong> units (${((itemSales[item] / totalUnits) * 100).toFixed(1)}%)
                `;
                legendList.appendChild(listItem);

                startAngle = endAngle;
                colorIndex++;
            }
        }


        /**
         * Provides a sample CSV file for download.
         * @param {Event} event The click event.
         */
        function downloadSampleCsv(event) {
            event.preventDefault(); // Prevent default link behavior
            const csvContent = `Date,Item_Name,Units_Sold
2025-07-15,Sourdough Loaf,100
2025-07-15,Croissant,150
2025-07-16,Sourdough Loaf,95
2025-07-16,Baguette,80
2025-07-17,Sourdough Loaf,110
2025-07-17,Muffin,120
2025-07-18,Sourdough Loaf,105
2025-07-18,Croissant,140
2025-07-19,Sourdough Loaf,130
2025-07-19,Baguette,90
2025-07-20,Sourdough Loaf,140
2025-07-20,Muffin,160
2025-07-21,Sourdough Loaf,115
2025-07-21,Croissant,135
2025-07-22,Sourdough Loaf,100
2025-07-22,Baguette,75
2025-07-23,Sourdough Loaf,120
2025-07-23,Muffin,110
2025-07-24,Sourdough Loaf,125
2025-07-24,Croissant,155
2025-07-25,Sourdough Loaf,135
25-07-25,Baguette,85
`;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'sample_bakery_sales.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        /**
         * Fetches mock weather data for the next 3 days and displays it.
         * @param {string} location The simulated location for the forecast.
         */
        async function fetchAndDisplayWeatherForecast(location) {
            const weatherForecastDiv = document.getElementById('weatherForecast');
            document.getElementById('currentLocationDisplay').textContent = `Current Location: ${location}`;
            weatherForecastDiv.innerHTML = '<p class="text-gray-500 text-center col-span-full">Fetching weather data...</p>';

            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 800));

            const today = new Date();
            const forecastData = [];

            for (let i = 0; i < 3; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dayName = i === 0 ? "Today" : i === 1 ? "Tomorrow" : date.toLocaleDateString('en-US', { weekday: 'short' });
                
                // Random weather for simulation
                const weatherOptions = ['Sunny', 'Cloudy', 'Rainy', 'Snowy'];
                const weather = weatherOptions[Math.floor(Math.random() * weatherOptions.length)];
                
                // Random temperature
                const tempLow = Math.floor(Math.random() * 20) + 40; // 40-60 F
                const tempHigh = tempLow + Math.floor(Math.random() * 15) + 5; // 45-75 F
                const feelsLikeTemp = Math.floor(Math.random() * (tempHigh - tempLow)) + tempLow; // A temp within range

                // Mock additional details
                const humidity = Math.floor(Math.random() * 30) + 60; // 60-90%
                const windSpeed = Math.floor(Math.random() * 10) + 5; // 5-15 mph
                const chanceOfPrecipitation = Math.floor(Math.random() * 60) + 10; // 10-70%

                forecastData.push({
                    day: dayName,
                    weather: weather,
                    temperature: `${tempLow}¬∞F - ${tempHigh}¬∞F`,
                    feelsLike: `${feelsLikeTemp}¬∞F Feels Like`, // New detail
                    humidity: `${humidity}% Humidity`,
                    wind: `${windSpeed} mph Wind`,
                    precipitation: `${chanceOfPrecipitation}% Chance of Rain`
                });
            }

            weatherForecastDiv.innerHTML = ''; // Clear loading message

            forecastData.forEach(day => {
                const card = document.createElement('div');
                card.className = 'weather-card';
                card.innerHTML = `
                    <span class="weather-icon">${weatherIcons[day.weather]}</span>
                    <span class="weather-day">${day.day}</span>
                    <span class="weather-temp">${day.temperature}</span>
                    <span class="weather-detail mt-1">${day.feelsLike}</span>
                    <span class="weather-detail">${day.humidity}</span>
                    <span class="weather-detail">${day.wind}</span>
                    <span class="weather-detail">${day.precipitation}</span>
                `;
                weatherForecastDiv.appendChild(card);
            });
        }

        /**
         * Calls the content generation service for a promotion blurb.
         */
        async function generatePromotionBlurb() {
            const blurbOutput = document.getElementById('blurbOutput');
            const blurbLoading = document.getElementById('blurbLoading');
            const generateBlurbButton = document.getElementById('generateBlurbButton');

            blurbOutput.classList.add('hidden'); // Hide previous blurb
            blurbLoading.classList.remove('hidden'); // Show loading spinner
            generateBlurbButton.disabled = true; // Disable button during generation

            const prompt = `You are a creative marketing assistant for a bakery. Write a short (2-3 sentences), enticing social media blurb to promote our "${selectedItem}" tomorrow. This item is predicted to sell ${predictedUnits} units, so highlight its popularity and demand. Use emojis relevant to baking and popularity.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            // Modified API URL and key handling to hide model/service specific details
            const apiKey = ""; // IMPORTANT: Insert your Google AI API key here to run this feature locally.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Implement exponential backoff for retries
                    const maxRetries = 3;
                    let retryCount = 0;
                    let delay = 1000; // 1 second

                    while (retryCount < maxRetries) {
                        console.warn(`API call failed (status: ${response.status}). Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        // Re-fetch logic needs to be defined
                        const retryResponse = await fetch(apiUrl, { 
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (retryResponse.ok) {
                            response = retryResponse; // Update response for outer scope
                            break; // Success, break retry loop
                        }
                        delay *= 2; // Exponential backoff
                        retryCount++;
                    }

                    if (!response.ok) { // If still not ok after retries
                        throw new Error(`API error after ${maxRetries} retries: ${response.status} ${response.statusText}`);
                    }
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    blurbOutput.textContent = text;
                    blurbOutput.classList.remove('hidden');
                } else {
                    showMessageBox("Failed to generate blurb. Unexpected response structure.");
                    blurbOutput.textContent = "Could not generate blurb.";
                    blurbOutput.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error calling content generation service:", error);
                showMessageBox(`Error generating blurb: ${error.message}. Please insert your API key into the code.`);
                blurbOutput.textContent = "Error generating blurb (API Key required).";
                blurbOutput.classList.remove('hidden');
            } finally {
                blurbLoading.classList.add('hidden'); // Hide loading spinner
                generateBlurbButton.disabled = false; // Re-enable button
            }
        }

        /**
         * Calls the content generation service for ingredient substitution suggestions.
         */
        async function getSubstitutionSuggestion() {
            const originalIngredient = document.getElementById('originalIngredient').value.trim();
            const substituteIngredient = document.getElementById('substituteIngredient').value.trim();
            const bakedGoodType = document.getElementById('bakedGoodType').value.trim();

            const suggestionOutput = document.getElementById('suggestionOutput');
            const suggestionLoading = document.getElementById('suggestionLoading');
            const getSuggestionButton = document.getElementById('getSuggestionButton');

            if (!originalIngredient) {
                showMessageBox("Please enter the original ingredient you want to substitute.");
                return;
            }

            suggestionOutput.classList.add('hidden');
            suggestionLoading.classList.remove('hidden');
            getSuggestionButton.disabled = true;

            let prompt = `I need ingredient substitution suggestions for baking. Original ingredient: "${originalIngredient}".`;
            if (substituteIngredient) {
                prompt += ` I'm looking to substitute it with/for: "${substituteIngredient}".`;
            }
            if (bakedGoodType) {
                prompt += ` The baked good I'm making is a "${bakedGoodType}".`;
            }
            prompt += ` Please provide 1-3 common substitutions, including approximate ratios if applicable, and a brief note on how it might affect the taste/texture. Format as a bulleted list.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            // Modified API URL and key handling to hide model/service specific details
            const apiKey = ""; // IMPORTANT: Insert your Google AI API key here to run this feature locally.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const maxRetries = 3;
                    let retryCount = 0;
                    let delay = 1000;

                    while (retryCount < maxRetries) {
                        console.warn(`API call failed (status: ${response.status}). Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        // Re-fetch logic needs to be defined
                        const retryResponse = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (retryResponse.ok) {
                            response = retryResponse;
                            break;
                        }
                        delay *= 2;
                        retryCount++;
                    }

                    if (!response.ok) {
                        throw new Error(`API error after ${maxRetries} retries: ${response.status} ${response.statusText}`);
                    }
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    suggestionOutput.textContent = text;
                    suggestionOutput.classList.remove('hidden');
                } else {
                    showMessageBox("Failed to get suggestion. Unexpected response structure.");
                    suggestionOutput.textContent = "Could not get suggestion.";
                    suggestionOutput.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error calling content generation service:", error);
                showMessageBox(`Error getting suggestion: ${error.message}. Please insert your API key into the code.`);
                suggestionOutput.textContent = "Error getting suggestion (API Key required).";
                suggestionOutput.classList.remove('hidden');
            } finally {
                suggestionLoading.classList.add('hidden');
                getSuggestionButton.disabled = false;
            }
        }
    </script>
</body>
</html>
